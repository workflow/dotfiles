# Screen PPIs:
#
# 34'' LG 32GR93U-B @ 3840x2160 ~ 140 PPI
{
  isHidpi,
  isPpiScaledOnePointFive,
  pkgs,
  ...
}: let
  baseHook = ''
    pkill -9 variety 2> /dev/null
    variety &>/dev/null &
  '';
  hidpiHook = ''
    ${baseHook}
      pkill -9 redshift-gtk 2> /dev/null # for applet to restart and adapt to hidpi
  '';
in {
  programs.autorandr = {
    enable = true;

    hooks = {
      postswitch = {
        background =
          if isHidpi || isPpiScaledOnePointFive
          then hidpiHook
          else baseHook;
        notify-i3 = "${pkgs.unstable.i3-gaps}/bin/i3-msg restart";
        change-dpi = ''
          case "$AUTORANDR_CURRENT_PROFILE" in
            movie)
              DPI=96
              ;;
            boar)
              DPI=144
              ;;
            single)
              DPI=96
              ;;
            flexbox)
              DPI=96
              ;;
            flexbox-intel)
              DPI=96
              ;;
            flexbox-intel-lo-res)
              DPI=96
              ;;
            flexbox-intel-hidpi)
              DPI=192
              ;;
            flexbox-caparica)
              DPI=96
              ;;
            *)
              echo "Unknown profle: $AUTORANDR_CURRENT_PROFILE"
              exit 1
          esac

          echo "Xft.dpi: $DPI" | ${pkgs.xorg.xrdb}/bin/xrdb -merge
        '';
      };
    };

    profiles = {
      "flexbox" = {
        fingerprint = {
          eDP-1-1 = "00ffffffffffff004d10d61400000000051e0104b52517780a3510aa5333ba250c51570000000101010101010101010101010101010172e700a0f0604590302036006ee51000001828b900a0f0604590302036006ee510000018000000fe00374a584b38804c513137305231000000000002410332011200000b010a202001d202030f00e3058000e606050160602800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa";
        };
        config = {
          eDP-1-1 = {
            enable = true;
            dpi = 96;
            mode = "2560x1600";
            position = "0x0";
            primary = true;
          };
        };
      };

      "flexbox-intel-hidpi" = {
        fingerprint = {
          eDP-1 = "00ffffffffffff004d10d61400000000051e0104b52517780a3510aa5333ba250c51570000000101010101010101010101010101010172e700a0f0604590302036006ee51000001828b900a0f0604590302036006ee510000018000000fe00374a584b38804c513137305231000000000002410332011200000b010a202001d202030f00e3058000e606050160602800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa";
        };
        config = {
          eDP-1 = {
            enable = true;
            dpi = 192;
            mode = "3840x2400";
            position = "0x0";
            primary = true;
          };
        };
      };

      "flexbox-intel" = {
        fingerprint = {
          eDP-1 = "00ffffffffffff004d10d61400000000051e0104b52517780a3510aa5333ba250c51570000000101010101010101010101010101010172e700a0f0604590302036006ee51000001828b900a0f0604590302036006ee510000018000000fe00374a584b38804c513137305231000000000002410332011200000b010a202001d202030f00e3058000e606050160602800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa";
        };
        config = {
          eDP-1 = {
            enable = true;
            dpi = 96;
            mode = "2560x1600";
            position = "0x0";
            primary = true;
          };
        };
      };

      "flexbox-intel-lo-res" = {
        fingerprint = {
          eDP-1 = "00ffffffffffff004d10d61400000000051e0104b52517780a3510aa5333ba250c51570000000101010101010101010101010101010172e700a0f0604590302036006ee51000001828b900a0f0604590302036006ee510000018000000fe00374a584b38804c513137305231000000000002410332011200000b010a202001d202030f00e3058000e606050160602800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa";
        };
        config = {
          eDP-1 = {
            enable = true;
            dpi = 96;
            mode = "1920x1200";
            position = "0x0";
            primary = true;
          };
        };
      };

      "boar" = {
        fingerprint = {
          DisplayPort-1 = "00ffffffffffff001e6dbd77b4d1030003220104c5462778f9ee55ac5240b0240e5054210900d1c06140454081c001010101010101014dd000a0f0703e803020350055502100001a000000fd0c3090505086010a202020202020000000fc004c4720554c545241474541522b000000ff003430334e544a4a37433239320a025702032e71230f070783474000453f10040301e2006ae305c000e60605016666546d1a0000020530900004683a683a09ec00a0a0a067503020350055502100001a5a8780a070384d403020350055502100001a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e701279030001000c5217200d000f700890784ebb0f000aa4140e0e070123000000030128d4080284ff0e9f0007801f006f0899008b0007006f4f0104ff0e9f0007801f006f0862005400070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005490";
          HDMI-A-0 = "00ffffffffffff001e6d5d5c6a76050003220103803c2278ea84d5ad5243af240c5054210800d1c061400101010101010101010101014dd000a0f0703e803020350058542100001a000000fd00323c1e873c000a202020202020000000fc004c4720554c54524146494e450a000000ff003430334e54445641483939340a012302034b7123090707830100004d01030410121f202261605f5e5d6d030c001000b83c20006001020367d85dc401788003e30f0003e2006ae305c000e6060501606050681a00000101283c00565e00a0a0a029503020350058542100001a023a801871382d40582c450058542100001a0000000000000000000000000000000086";
          HDMI-A-1 = "00ffffffffffff001e6d5d5c6c76050003220103803c2278ea84d5ad5243af240c5054210800d1c061400101010101010101010101014dd000a0f0703e803020350058542100001a000000fd00323c1e873c000a202020202020000000fc004c4720554c54524146494e450a000000ff003430334e54455041483939360a012402034b7123090707830100004d01030410121f202261605f5e5d6d030c001000b83c20006001020367d85dc401788003e30f0003e2006ae305c000e6060501606050681a00000101283c00565e00a0a0a029503020350058542100001a023a801871382d40582c450058542100001a0000000000000000000000000000000086";
        };
        config = {
          HDMI-A-1 = {
            enable = true;
            dpi = 144;
            mode = "3840x2160";
            position = "0x0";
            rate = "60.00";
            rotate = "left";
          };
          DisplayPort-1 = {
            enable = true;
            primary = true;
            dpi = 144;
            mode = "3840x2160";
            position = "2160x737";
            rate = "144.05";
          };
          HDMI-A-0 = {
            enable = true;
            dpi = 144;
            mode = "3840x2160";
            position = "6000x0";
            rate = "60.00";
            rotate = "left";
          };
        };
      };

      "flexbox-caparica" = {
        fingerprint = {
          DP-2-1 = "00ffffffffffff005c2d002701000000191e0103803c21783e2d1fa6564fa0260d4f53a56b80b300a9c0950081008140818081c07140565e00a0a0a029503020350055502100001e023a801871382d40582c450055502100001e000000fd00305f1ee13c000a202020202020000000fc005732373050524f0a202020202001df020340f34c01030507049011121314161f23090707830100006a030c001000187820000067d85dc40178c000681a00000101305fede305e301e60607016060455d9300a0a0a014503020350056502100001a047600a0a0a0295030203600bc862100001a00000000000000000000000000000000000000000000000000000094";
          DP-2-3 = "00ffffffffffff004c2d797031574a300f200103803c22782a6eb5ae4f46a626115054bfef80714f810081c081809500a9c0b3000101565e00a0a0a029503020350055502100001a000000fd00324b1e5919000a202020202020000000fc004c433237473578540a20202020000000ff00484e41543430303130310a202001fd020336f149901f041303125d60612309070783010000e305c0006b030c001000983c2000200367d85dc401788001e3060501e30f8001023a801871382d40582c450055502100001e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038";
          eDP-1 = "00ffffffffffff004d10d61400000000051e0104b52517780a3510aa5333ba250c51570000000101010101010101010101010101010172e700a0f0604590302036006ee51000001828b900a0f0604590302036006ee510000018000000fe00374a584b38804c513137305231000000000002410332011200000b010a202001d202030f00e3058000e606050160602800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000aa";
        };
        config = {
          eDP-1 = {
            enable = false;
            dpi = 96;
            mode = "1680x1050";
            position = "2560x390";
            rate = "59.95";
          };
          DP-2-1 = {
            enable = true;
            dpi = 96;
            mode = "2560x1440";
            position = "0x0";
            primary = true;
            rate = "95.00";
          };
          DP-2-3 = {
            enable = true;
            dpi = 96;
            mode = "2560x1440";
            position = "2560x0";
            primary = false;
            rate = "120.00";
          };
        };
      };

      "single" = {
        fingerprint = {
          DP-0 = "00ffffffffffff005c2d002700000000191e0104b53c21783be640ac4f44ad270c5054a54b00714f81c081809500b300d1c001010101565e00a0a0a029503020350055502100001e023a801871382d403020350029501100001e000000fd00305fdfdf3c010a202020202020000000fc005732373050524f0a20202020200137020327754c01030405079011121314161f2309070783010000e200c0e305e301e60607016060445d9300a0a0a014503020350056502100001e047600a0a0a0295030203600bc862100001e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000054";
          DP-2 = "00ffffffffffff005c2d002700000000191e0104b53c21783be640ac4f44ad270c5054a54b00714f81c081809500b300d1c001010101565e00a0a0a029503020350055502100001e023a801871382d403020350029501100001e000000fd00305fdfdf3c010a202020202020000000fc005732373050524f0a20202020200137020327754c01030405079011121314161f2309070783010000e200c0e305e301e60607016060445d9300a0a0a014503020350056502100001e047600a0a0a0295030203600bc862100001e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000054";
        };
        config = {
          DP-2 = {
            enable = true;
            dpi = 96;
            mode = "2560x1440";
            position = "0x0";
            rate = "95.00";
            primary = true;
          };
          DP-0 = {
            enable = false;
          };
        };
      };

      "movie" = {
        fingerprint = {
          eDP-1 = "00ffffffffffff0030e48b0500000000001a0104a51f1178e25715a150469d290f505400000001010101010101010101010101010101695e00a0a0a029503020a50035ae1000001a000000000000000000000000000000000000000000fe004c4720446973706c61790a2020000000fe004c503134305148322d5350423100b8";
        };
        config = {
          eDP-1 = {
            enable = true;
            #dpi = 210;
            dpi = 96;
            mode = "2560x1440";
            position = "0x0";
            primary = true;
            rate = "60.00";
          };
        };
      };
    };
  };
}
